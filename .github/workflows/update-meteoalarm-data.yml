name: Check MeteoAlarm Data Updates

on:
  schedule:
    # Run quarterly on the 1st day of January, April, July, and October at 05:00 UTC
    - cron: '0 5 1 1,4,7,10 *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  issues: write

jobs:
  check-for-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.0

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Check for MeteoAlarm repository updates
        id: check-updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import json
          import os
          import requests
          from datetime import datetime, timedelta, timezone

          # Official MeteoAlarm GitLab repository
          # Source: https://gitlab.com/meteoalarm-pm-group/documents
          GITLAB_API_URL = "https://gitlab.com/api/v4/projects/meteoalarm-pm-group%2Fdocuments/repository/commits"

          # Check for commits in the last 90 days (quarterly check)
          def get_recent_commits():
              """Get recent commits from the MeteoAlarm GitLab repository."""
              try:
                  since_date = (datetime.now(timezone.utc) - timedelta(days=90)).isoformat()
                  response = requests.get(
                      GITLAB_API_URL,
                      params={"since": since_date, "per_page": 10},
                      timeout=60
                  )
                  response.raise_for_status()
                  return response.json()
              except Exception as e:
                  print(f"Error fetching commits: {e}")
                  return []

          print("Checking for updates in MeteoAlarm GitLab repository...")
          commits = get_recent_commits()

          if commits:
              print(f"Found {len(commits)} recent commit(s) in the last 90 days:")
              commit_info = []
              for commit in commits[:5]:  # Show up to 5 recent commits
                  short_id = commit.get("short_id", "unknown")
                  title = commit.get("title", "No title")
                  date = commit.get("created_at", "unknown")
                  print(f"  - {short_id}: {title} ({date})")
                  commit_info.append(f"- `{short_id}`: {title} ({date})")
              
              # Write outputs for GitHub Actions
              with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as f:
                  f.write("has_updates=true\n")
                  f.write(f"commit_count={len(commits)}\n")
          else:
              print("No recent updates found in the MeteoAlarm repository.")
              with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as f:
                  f.write("has_updates=false\n")
          EOF

      - name: Check for existing issue
        if: steps.check-updates.outputs.has_updates == 'true'
        id: check-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if an open issue with the label already exists
          existing=$(gh issue list --label "meteoalarm-update" --state open --limit 1 --json number --jq '.[0].number // empty')
          if [ -n "$existing" ]; then
            echo "existing_issue=$existing" >> $GITHUB_OUTPUT
            echo "Issue #$existing already exists"
          else
            echo "existing_issue=" >> $GITHUB_OUTPUT
            echo "No existing issue found"
          fi

      - name: Create issue for MeteoAlarm updates
        if: steps.check-updates.outputs.has_updates == 'true' && steps.check-issue.outputs.existing_issue == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "MeteoAlarm data files may need updating" \
            --label "meteoalarm-update" \
            --body "## MeteoAlarm Repository Update Detected

          The [MeteoAlarm GitLab repository](https://gitlab.com/meteoalarm-pm-group/documents) has had recent updates in the last 90 days.

          ### Action Required
          Please review the following files for potential updates:
          - \`API/data/meteoalarm_geocodes.json\`
          - \`API/data/meteoalarm_aliases.csv\`

          ### Source Files
          - [MeteoAlarm Documents Repository](https://gitlab.com/meteoalarm-pm-group/documents) - Browse for latest geocodes JSON files

          ### Notes
          - The CSV files in the source repository are not versioned, so manual review is required
          - Recent commits found: ${{ steps.check-updates.outputs.commit_count }}

          ---
          *This issue was automatically created by the Check MeteoAlarm Data Updates workflow.*"
