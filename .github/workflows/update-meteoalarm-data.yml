name: Update MeteoAlarm Data

on:
  schedule:
    # Run quarterly on the 1st day of January, April, July, and October at 05:00 UTC
    - cron: '0 5 1 1,4,7,10 *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-for-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.0

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Check and update MeteoAlarm files
        id: update-files
        run: |
          python << 'EOF'
          import hashlib
          import json
          import os
          import requests

          # Source URLs
          GEOCODES_URL = "https://raw.githubusercontent.com/NiklasJordan/meteoalarm/main/src/meteoalarm/assets/geocodes.json"
          # Note: meteoalarm_aliases.csv currently has no clear upstream source
          # The file appears to be maintained locally or derived from meteoalarm data

          # Local file paths
          GEOCODES_PATH = "API/data/meteoalarm_geocodes.json"
          ALIASES_PATH = "API/data/meteoalarm_aliases.csv"

          changes = []

          def get_file_hash(filepath):
              """Calculate SHA256 hash of a file."""
              if not os.path.exists(filepath):
                  return None
              with open(filepath, "rb") as f:
                  return hashlib.sha256(f.read()).hexdigest()

          def download_file(url):
              """Download file content from URL."""
              response = requests.get(url, timeout=60)
              response.raise_for_status()
              return response.content

          # Check and update geocodes.json
          print("Checking for geocodes.json updates...")
          try:
              current_hash = get_file_hash(GEOCODES_PATH)
              new_content = download_file(GEOCODES_URL)
              new_hash = hashlib.sha256(new_content).hexdigest()
              
              if current_hash != new_hash:
                  print(f"Update found for geocodes.json")
                  print(f"  Current hash: {current_hash}")
                  print(f"  New hash: {new_hash}")
                  with open(GEOCODES_PATH, "wb") as f:
                      f.write(new_content)
                  changes.append("meteoalarm_geocodes.json")
              else:
                  print("geocodes.json is up to date")
          except Exception as e:
              print(f"Error checking geocodes.json: {e}")

          # Write output for GitHub Actions
          with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as f:
              if changes:
                  f.write(f"has_changes=true\n")
                  f.write(f"changed_files={', '.join(changes)}\n")
              else:
                  f.write("has_changes=false\n")

          print(f"\nSummary: {len(changes)} file(s) updated")
          EOF

      - name: Create Pull Request
        if: steps.update-files.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7.0.9
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update MeteoAlarm geocodes data"
          title: "chore: Update MeteoAlarm geocodes"
          body: |
            This PR updates the MeteoAlarm geocodes data file.

            ## Changed files
            ${{ steps.update-files.outputs.changed_files }}

            ## Source
            - `meteoalarm_geocodes.json` is sourced from [NiklasJordan/meteoalarm](https://github.com/NiklasJordan/meteoalarm/blob/main/src/meteoalarm/assets/geocodes.json)

            ---
            *This PR was automatically generated by the Update MeteoAlarm Data workflow.*
          branch: update-meteoalarm-data
          delete-branch: true
          labels: |
            dependencies
            automated
