# Updating and Adding Weather Summary Logic

This document provides guidance on how to modify existing weather summary logic and how to introduce entirely new summary descriptions and icons within the Pirate Weather codebase. The core files involved are `API/responseLocal.py` and the various `API/Pirate*Text.py` scripts.

## Part 1: Updating Existing Summary Logic

The weather summaries and icons are generated by functions within dedicated Python files in the `API/` directory. These functions determine the `summary` text and `icon` based on processed weather data.

1.  **Identify the Relevant Text Generation File**:

    * Summaries are generated based on different time granularities:

        * `API/PirateText.py`: Contains the `calculate_text` function, which is used for `currently` and `hourly` summaries.

        * `API/PirateMinutelyText.py`: Contains the `calculate_minutely_text` function for `minutely` summaries.

        * `API/PirateDailyText.py`: Contains the `calculate_day_text` function for `daily` summaries.

        * `API/PirateWeeklyText.py`: Contains the `calculate_weekly_text` function for the overall `daily` summary.

    * Locate the file corresponding to the summary type you wish to update.

2.  **Understand the Logic**:

    * Open the identified file and examine the `calculate_*_text` function. You will find a series of `if/elif/else` conditions that evaluate different weather parameters (e.g., `precipIntensity`, `cloudCover`, `windSpeed`, `precipType`, `temperature`).

    * These conditions assign a `text` string (e.g., "clear", "rain", "partly-cloudy") and an `icon` string (e.g., "clear-day", "rain", "partly-cloudy-day").

    * **Prioritization**: Note that the order of `if/elif` statements is crucial, as the first condition met will determine the summary. Typically, more impactful weather conditions (like heavy precipitation or fog) are checked first, followed by general conditions (like cloud cover or wind).

3.  **Modify Conditions and Thresholds**:

    * To update existing logic, change the conditions (`>`, `<`, `==`, `is not None`), the thresholds (e.g., `0.75` for `cloudCover`), or the assigned `text` and `icon` strings.

    * For instance, if you want "wind" to be reported at a lower speed, adjust the `windSpeed` threshold. If you want "partly-cloudy-day" to appear for a different cloud cover percentage, modify that condition.

4.  **Test Your Changes**:

    * After modifying the logic, run the API locally and make cURL requests for locations and times that you expect to be affected by your changes.

    * Verify that the `summary` and `icon` in the JSON response reflect your updated logic.

## Part 2: Adding a New Summary to the List

Adding a completely new summary (e.g., "Slightly Breezy" or "Dust Storm") involves defining its conditions, adding it to the translation library, and then integrating it into the API's text generation.

1.  **Define the New Summary's Conditions and Text**:

    * Determine the specific weather parameters and their thresholds that should trigger your new summary.

    * Choose a concise `text` identifier (e.g., "slightly-breezy") and a corresponding `icon` identifier (e.g., "breezy").

2.  **Add the Summary to the Translations Library (CRITICAL)**:

    * **Check Existing Translations**: Before making a Pull Request, first check the [Pirate Weather Translations repository](https://github.com/Pirate-Weather/translations). It's possible a similar summary already exists or that your new summary could be integrated as a variation of an existing one.

    * If your summary text does *not* exist, you **must create a Pull Request (PR) to the `pirateweather-translations` library** to include your new summary text. This ensures that the API can translate the summary into various languages and use the correct icon mapping.

    * **Guidance for PR**: In your PR, specify the new `text` key and provide their English translations, and ideally, translations for other supported languages. The translation library is dynamically loaded by `responseLocal.py`.

3.  **Integrate into API Text Generation (`API/Pirate*Text.py` and `API/responseLocal.py`)**:

    * **Modify `calculate_*_text` Function**: In the appropriate text generation file (`API/PirateText.py`, `API/PirateMinutelyText.py`, `API/PirateDailyText.py`, or `API/PirateWeeklyText.py`), add a new `elif` (or `if`, if it's a high-priority condition) block for your new summary.

        * Place this block strategically within the `if/elif` chain, considering its priority relative to other summaries. For instance, "Dust Storm" might have a higher priority than "Cloudy."

        * Assign your chosen `text` identifier and `icon` identifier within this new block.

        * **Example**:

            ```python
            # In calculate_text function (PirateText.py)
            elif (weather_data["windSpeed"] > (15 * windUnit)) and (weather_data["visibility"] < (5000 * visUnits)):
                hourText = "dusty"
                hourIcon = "dusty"
            ```

        * **Icon Guidelines**: Please try to stick to the existing icon fields (`clear-day`, `clear-night`, `rain`, `snow`, `sleet`, `wind`, `fog`, `cloudy`, `partly-cloudy-day`, `partly-cloudy-night`, `thunderstorm`, `hail`, `mixed`) and if needed you can add a new icon to be accessible only when the `icon=pirate` query string is included in the API request. A new icon not accessible by the `icon=pirate` query string parameter should only be added if an existing icon does not accurately match the summary you are trying to add.

    * **Update `responseLocal.py` calls (if applicable)**:

        * The `responseLocal.py` script calls `calculate_text`, `calculate_minutely_text`, etc., and then uses `translation.translate` to convert the summary text. Because you added your new summary to the `pirateweather-translations` library, this `translate` call will now correctly handle your new summary.

        * No direct code change is usually needed in `responseLocal.py` for *translation* once the translation library is updated. However, if your new summary impacts the logic in `responseLocal.py` directly (e.g., changes how `dayIcon` or `dayText` are determined at a higher level), ensure those parts are also updated.

4.  **Thorough Testing**:

    * Test your changes comprehensively with various locations and times that you expect to trigger the new summary.

    * Verify both the summary text and the icon are correct in the API response.

    * Crucially, test different `lang` query parameters to ensure the translation works as expected for your new summary.